<!DOCTYPE html>
<html>

<head>
	<title>Feed U - Home Page</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="../css/base.css" />

	<script src="../bundle.js"></script>

</head>

<body>
	<div data-role="page" id="home" class="feedU-page ui-responsive-panel">

		<div data-role="header" data-position="fixed" id="home-header" data-tap-toggle="false">
			<a id="navigation-menu-hamburger" href="#navigation-menu"
				class="ui-btn ui-shadow ui-corner-all ui-icon-bars ui-btn-icon-notext">Delete</a>
			<span class="ui-title"></span>
			<img src="../assets/logo.png"></img>
		</div>

		<div role="main" class="ui-content">
			<div id="home-main-content-container">
				<div class="user-delivery-location-details">
					<span id="deliver-now-txt">Deliver Now | </span>
					<!-- 
							https://css-tricks.com/flexbox-truncated-text/ 
							TODO fix for longer display names
						-->
					<span id="user-home-delivery-location">Delivery Location </span>
					<!-- 
						TODO if we set href here to set_location page it doesn't work. works for any other page.
						Also, manual jQuery AJAX navigation works.
					-->
					<a class="link-set-location-page ui-btn ui-shadow ui-corner-all ui-icon-navigation ui-btn-icon-notext"
						style="margin-left: 5px;"></a>
				</div>
				<div id="home-favourite-stories-section">
					<p>Stories</p>
					<div id="home-favourite-vendor-stories-container">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png"
							onclick="onStoryClick()">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
						<img class="favourite-vendor-story" src="../assets/stories_images/story.png">
					</div>
				</div>
				<div id="home-pois-section">
					<p>Categories</p>
					<div id="home-container" class="all-poi-container"></div>
				</div>
			</div>
		</div>

		<div id="home-footer" data-role="footer" data-position="fixed" data-tap-toggle="false"
			style="background-color: #27AE60; color: white; text-shadow: none; padding: 7px 0px">
			<h4>CHECKOUT</h4>
		</div>

		<script>

			const { user } = app;

			$(".link-set-location-page").click(function (event) {
				event.preventDefault();
				$.mobile.navigate("set_location.html");
			})

			function onStoryClick(event) {
				console.log('Clicked a story. Opening the story.');

				// refer https://jquerymobile.com/upgrade-guide/1.4/#navigation on how to navigate

				// navigate user to Home screen when user submits their location
				// refer https://stackoverflow.com/questions/24173871/what-is-the-mobile-pagecontainer-selector and
				// https://api.jquerymobile.com/pagecontainer/ for more
				$(":mobile-pagecontainer").pagecontainer("change", "vendor_stories.html", { transition: "slide" });
			};
			// The code below uses ES6 syntax since modern browsers support it (Chrome / Edge versions released after 2016)
			// Refer https://www.w3schools.com/js/js_versions.asp for more

			const { datastore } = app;

			var vendors = datastore.getAllVendors(); // TODO refactor this once mock data is removed

			// render items in order summary
			vendors.forEach(({ vendorId, vendorImageLocation, vendorName, vendorCatergories, vendorRatings, deliveryTime }) => {
				var markupP1 = `<div class="poi-container" vendor-id="${vendorId}">
					<img src=${vendorImageLocation} class="poi-image">
					<div class="poi-details">
						<div>${vendorName}</div>
						<div class="poi-catergory-container">`
				var markupP2 = ``
				var i = 0;
				vendorCatergories.forEach((category) => {
					if (i === 0) {
						markupP2 = markupP2 + `<i class="fa fa-circle" id="poi-catergory"></i>${category}`
					} else {
						markupP2 = markupP2 + `<i class="fa fa-circle" id="poi-catergory" style="margin-left: 2em;"></i>${category}`
					}
					i = i + 1;
				});
				var markupP3 =
					`</div>
						<div class="poi-rating-bar-container">
							<div class="poi-rating-bar">
								<span><i class='fa fa-star fa-fw' id="poi-rate-star-icon"></i> ${vendorRatings.vendorRatingValue} 
								</span>
								<small id="poi-no-of-rated-customers">(${vendorRatings.vendorNoOfRatings})</small>
							</div>
							<div id="poi-delivery-time">${deliveryTime}</div>
						</div>
					</div>
				</div>`
				var markup = markupP1 + markupP2 + markupP3;
				$('#home-container').append(markup)
			});

			$('body').on("pagecontainershow", function (event, ui) {
				// This event will get fired each time the pagecontainershow event fires,
				// that means it'll fire even when loading another page (other than home.html)

				var activePage = ui.toPage[0].id;
				if (activePage === 'home') {
					// Retrieve user location from cookie and set to label
					$("#user-home-delivery-location").text(user.getDetails().location.display);
				}
			});

			// Handle Vendor POI click event
			// https://stackoverflow.com/questions/943987/add-jquery-click-handler-to-multiple-elements
			$(".poi-container").click(function () {
				var vendorId = $(this).attr("vendor-id"); // which vendor card was clicked
				$(":mobile-pagecontainer").pagecontainer("change", "vendor_page.html", {
					data: {
						vendorId
					}
				});
			});

			$("#home-footer").on("click", function (event) {
				$(":mobile-pagecontainer").pagecontainer("change", "checkout.html");
			});
		</script>
	</div>

</body>

</html>